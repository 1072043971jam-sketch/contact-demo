<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆåŒå¤„ç†ç³»ç»Ÿ - å¯è§†åŒ–æ¼”ç¤º</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #fff;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { text-align: center; margin-bottom: 10px; font-size: 28px; }
    .subtitle { text-align: center; color: #8892b0; margin-bottom: 30px; }

    /* æ§åˆ¶é¢æ¿ */
    .control-panel {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    .control-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
    .control-group { display: flex; align-items: center; gap: 8px; }
    label { font-size: 14px; color: #ccd6f6; }

    /* è‡ªå®šä¹‰ä¸‹æ‹‰èœå• */
    .custom-dropdown { position: relative; }
    .dropdown-trigger {
      padding: 8px 30px 8px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(45, 55, 72, 0.9);
      color: #e2e8f0;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      user-select: none;
    }
    .dropdown-trigger:hover { background: rgba(45, 55, 72, 1); }
    .dropdown-trigger::after {
      content: 'â–¼';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #a0aec0;
    }
    .dropdown-menu {
      position: absolute;
      top: calc(100% + 5px);
      left: 0;
      right: 0;
      background: #2d3748;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .dropdown-item {
      padding: 10px 12px;
      color: #e2e8f0;
      cursor: pointer;
      transition: background 0.15s;
      font-size: 14px;
    }
    .dropdown-item:hover { background: #4a5568; color: #fff; }
    .dropdown-item.selected { background: #667eea; color: #fff; }
    select, input {
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 14px;
    }
    select:focus, input:focus { outline: none; border-color: #667eea; }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
    .btn-success { background: #28a745; color: #fff; }
    .btn-info { background: #17a2b8; color: #fff; }
    .btn-warning { background: #ffc107; color: #000; }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .stat-label { font-size: 12px; color: #8892b0; margin-bottom: 8px; }
    .stat-value { font-size: 28px; font-weight: 600; }
    .stat-value.highlight { color: #667eea; }

    /* è¡¨æ ¼ */
    .table-container {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
    }
    table { width: 100%; border-collapse: collapse; }
    thead { background: rgba(255,255,255,0.1); }
    th { padding: 15px; text-align: left; font-weight: 600; font-size: 13px; color: #ccd6f6; text-transform: uppercase; }
    td { padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
    tbody tr:hover { background: rgba(255,255,255,0.05); }
    tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }

    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-expired { background: #f8d7da; color: #721c24; }
    .status-draft { background: #fff3cd; color: #856404; }
    .status-terminated { background: #e2e3e5; color: #383d41; }

    /* åˆ†é¡µ */
    .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 20px; }
    .page-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .page-btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); }
    .page-btn.active { background: #667eea; border-color: #667eea; }
    .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ä»£ç å±•ç¤º */
    .code-panel {
      background: #0d1117;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .code-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .code-title { font-size: 14px; color: #ccd6f6; }
    .code-content {
      background: rgba(0,0,0,0.3);
      padding: 15px;
      border-radius: 8px;
      font-family: 'Consolas', monospace;
      font-size: 13px;
      color: #c9d1d9;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* æ—¥å¿— */
    .log-panel {
      background: #0d1117;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .log-entry {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-family: 'Consolas', monospace;
      font-size: 13px;
    }
    .log-time { color: #8892b0; margin-right: 10px; }
    .log-info { color: #58a6ff; }
    .log-success { color: #3fb950; }
    .log-error { color: #f85149; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š åˆåŒå¤„ç†ç³»ç»Ÿ - å¯è§†åŒ–æ¼”ç¤º</h1>
    <p class="subtitle">åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•æ‰€æœ‰åŠŸèƒ½ï¼Œæ— éœ€å®‰è£…ä»»ä½•ä¾èµ–</p>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
      <div class="control-row">
        <div class="control-group">
          <label>çŠ¶æ€ç­›é€‰:</label>
          <div class="custom-dropdown" style="width: 120px;">
            <div class="dropdown-trigger" id="statusTrigger" onclick="toggleDropdown('status')">å…¨éƒ¨</div>
            <div class="dropdown-menu" id="statusMenu" style="display: none;">
              <div class="dropdown-item" data-value="">å…¨éƒ¨</div>
              <div class="dropdown-item" data-value="active">ç”Ÿæ•ˆä¸­</div>
              <div class="dropdown-item" data-value="expired">å·²è¿‡æœŸ</div>
              <div class="dropdown-item" data-value="draft">è‰ç¨¿</div>
              <div class="dropdown-item" data-value="terminated">å·²ç»ˆæ­¢</div>
            </div>
            <input type="hidden" id="statusFilter" value="">
          </div>
        </div>
        <div class="control-group">
          <label>ç±»å‹ç­›é€‰:</label>
          <div class="custom-dropdown" style="width: 120px;">
            <div class="dropdown-trigger" id="typeTrigger" onclick="toggleDropdown('type')">å…¨éƒ¨</div>
            <div class="dropdown-menu" id="typeMenu" style="display: none;">
              <div class="dropdown-item" data-value="">å…¨éƒ¨</div>
              <div class="dropdown-item" data-value="é‡‡è´­åˆåŒ">é‡‡è´­åˆåŒ</div>
              <div class="dropdown-item" data-value="é”€å”®åˆåŒ">é”€å”®åˆåŒ</div>
              <div class="dropdown-item" data-value="æœåŠ¡åˆåŒ">æœåŠ¡åˆåŒ</div>
              <div class="dropdown-item" data-value="ç§ŸèµåˆåŒ">ç§ŸèµåˆåŒ</div>
              <div class="dropdown-item" data-value="åŠ³åŠ¡åˆåŒ">åŠ³åŠ¡åˆåŒ</div>
            </div>
            <input type="hidden" id="typeFilter" value="">
          </div>
        </div>
        <div class="control-group">
          <label>æœç´¢:</label>
          <input type="text" id="searchInput" placeholder="åˆåŒåç§°/ç¼–å·..." style="width: 200px;">
        </div>
        <button class="btn-primary" onclick="applyFilters()">ğŸ” æœç´¢</button>
        <button class="btn-success" onclick="exportHTML()">ğŸ“„ å¯¼å‡ºHTML</button>
        <button class="btn-success" onclick="exportCSV()">ğŸ“Š å¯¼å‡ºCSV</button>
        <button class="btn-info" onclick="showGeneratedScript()">ğŸ“œ ç”Ÿæˆè„šæœ¬</button>
        <button class="btn-warning" onclick="resetData()">ğŸ”„ é‡ç½®æ•°æ®</button>
      </div>
    </div>

    <!-- ç»Ÿè®¡ -->
    <div class="stats" id="stats"></div>

    <!-- è¡¨æ ¼ -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>åˆåŒç¼–å·</th>
            <th>åˆåŒåç§°</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>å¯¹æ–¹å•ä½</th>
            <th>çŠ¶æ€</th>
            <th>å¼€å§‹æ—¥æœŸ</th>
            <th>ç»“æŸæ—¥æœŸ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination"></div>

    <!-- ç”Ÿæˆçš„è„šæœ¬ -->
    <div class="code-panel" id="scriptPanel" style="display: none;">
      <div class="code-header">
        <span class="code-title">ğŸ“œ ç”Ÿæˆçš„ Native.js è„šæœ¬</span>
        <button onclick="copyScript()" class="btn-primary">å¤åˆ¶</button>
      </div>
      <div class="code-content" id="scriptContent"></div>
    </div>

    <!-- Native.js æ•°æ®æ£€æµ‹ -->
    <div class="code-panel">
      <div class="code-header">
        <span class="code-title">ğŸ” Native.js æ¨¡å—æ£€æµ‹</span>
        <div>
          <button onclick="testFetchAll()" class="btn-primary">æµ‹è¯•è·å–æ•°æ®</button>
          <button onclick="testUpdate()" class="btn-warning">æµ‹è¯•æ›´æ–°æ•°æ®</button>
        </div>
      </div>
      <div style="margin: 15px 0;">
        <label style="color: #8892b0; font-size: 13px; display: block; margin-bottom: 10px;">ç­›é€‰æ¡ä»¶:</label>
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <div class="control-group">
            <label>çŠ¶æ€:</label>
            <div class="custom-dropdown" style="width: 120px;">
              <div class="dropdown-trigger" id="testStatusTrigger" onclick="toggleDropdown('testStatus')">å…¨éƒ¨</div>
              <div class="dropdown-menu" id="testStatusMenu" style="display: none;">
                <div class="dropdown-item" data-value="">å…¨éƒ¨</div>
                <div class="dropdown-item" data-value="active">ç”Ÿæ•ˆä¸­</div>
                <div class="dropdown-item" data-value="expired">å·²è¿‡æœŸ</div>
                <div class="dropdown-item" data-value="draft">è‰ç¨¿</div>
              </div>
              <input type="hidden" id="testStatusFilter" value="">
            </div>
          </div>
          <div class="control-group">
            <label>ç±»å‹:</label>
            <div class="custom-dropdown" style="width: 120px;">
              <div class="dropdown-trigger" id="testTypeTrigger" onclick="toggleDropdown('testType')">å…¨éƒ¨</div>
              <div class="dropdown-menu" id="testTypeMenu" style="display: none;">
                <div class="dropdown-item" data-value="">å…¨éƒ¨</div>
                <div class="dropdown-item" data-value="é‡‡è´­åˆåŒ">é‡‡è´­åˆåŒ</div>
                <div class="dropdown-item" data-value="é”€å”®åˆåŒ">é”€å”®åˆåŒ</div>
                <div class="dropdown-item" data-value="æœåŠ¡åˆåŒ">æœåŠ¡åˆåŒ</div>
                <div class="dropdown-item" data-value="ç§ŸèµåˆåŒ">ç§ŸèµåˆåŒ</div>
                <div class="dropdown-item" data-value="åŠ³åŠ¡åˆåŒ">åŠ³åŠ¡åˆåŒ</div>
              </div>
              <input type="hidden" id="testTypeFilter" value="">
            </div>
          </div>
          <div class="control-group">
            <label>æœ€å¤§é‡‘é¢:</label>
            <input type="number" id="testMaxAmount" placeholder="å¦‚: 100000" style="width: 110px; background: #2d3748; color: #e2e8f0; border: 1px solid #4a5568;">
          </div>
          <button onclick="testFetchFilterSimple()" class="btn-primary" style="padding: 8px 16px;">æŒ‰æ¡ä»¶æŸ¥è¯¢</button>
        </div>
      </div>
      <div class="code-content" id="testResult" style="max-height: 300px; white-space: pre-wrap; font-size: 13px; line-height: 1.6;">
ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æµ‹è¯• Native.js æ¨¡å—åŠŸèƒ½

æµ‹è¯•è¯´æ˜ï¼š
â€¢ "æµ‹è¯•è·å–æ•°æ®" - æ˜¾ç¤ºå‰3æ¡åˆåŒæ•°æ®
â€¢ "æŒ‰æ¡ä»¶æŸ¥è¯¢" - æ ¹æ®ä¸Šæ–¹ç­›é€‰æ¡ä»¶æŸ¥è¯¢
â€¢ "æµ‹è¯•æ›´æ–°æ•°æ®" - éšæœºæ›´æ–°ä¸€æ¡æ•°æ®å¹¶æ˜¾ç¤ºå˜åŒ–
      </div>
    </div>

    <!-- æ“ä½œæ—¥å¿— -->
    <div class="log-panel">
      <div class="code-header"><span class="code-title">ğŸ“‹ æ“ä½œæ—¥å¿—</span></div>
      <div id="logContent"></div>
    </div>
  </div>

  <script>
    // ==================== æ¨¡æ‹Ÿæ•°æ®æº ====================
    class MockDataSource {
      constructor() {
        this._contracts = this._generateData(50);
      }

      _generateData(count) {
        const data = [];
        const statuses = ['draft', 'active', 'expired', 'terminated'];
        const types = ['é‡‡è´­åˆåŒ', 'é”€å”®åˆåŒ', 'æœåŠ¡åˆåŒ', 'ç§ŸèµåˆåŒ', 'åŠ³åŠ¡åˆåŒ'];
        const companies = ['ç§‘æŠ€è‚¡ä»½å…¬å¸', 'è´¸æ˜“é›†å›¢', 'å®ä¸šæ§è‚¡', 'ç½‘ç»œæŠ€æœ¯', 'å’¨è¯¢æœåŠ¡'];

        for (let i = 1; i <= count; i++) {
          const startDate = new Date(2023 + Math.floor(Math.random() * 3), Math.floor(Math.random() * 12), Math.floor(Math.random() * 28) + 1);
          const endDate = new Date(startDate);
          endDate.setFullYear(endDate.getFullYear() + 1);

          data.push({
            id: `CT${String(i).padStart(4, '0')}`,
            contractNumber: `HT${new Date().getFullYear()}${String(i).padStart(5, '0')}`,
            name: `${companies[i % companies.length]}${types[i % types.length]}`,
            type: types[i % types.length],
            amount: Math.floor(Math.random() * 900000) + 10000,
            currency: 'CNY',
            status: statuses[i % statuses.length],
            counterparty: `åˆä½œæ–¹${String(i).padStart(2, '0')}`,
            startDate: startDate.toISOString().split('T')[0],
            endDate: endDate.toISOString().split('T')[0],
            createdAt: startDate.toISOString(),
            updatedAt: new Date().toISOString(),
            fields: {
              department: ['é‡‡è´­éƒ¨', 'é”€å”®éƒ¨', 'è¡Œæ”¿éƒ¨'][i % 3],
              responsible: `è´Ÿè´£äºº${String(i).padStart(2, '0')}`,
              paymentTerms: ['æœˆç»“', 'å­£ç»“', 'å¹´ç»“'][i % 3]
            }
          });
        }
        return data;
      }

      async getContracts(filters = {}) {
        await delay(50);
        let contracts = [...this._contracts];

        if (filters.status) contracts = contracts.filter(c => c.status === filters.status);
        if (filters.type) contracts = contracts.filter(c => c.type === filters.type);
        if (filters.counterparty) contracts = contracts.filter(c => c.counterparty === filters.counterparty);
        if (filters.minAmount !== undefined) contracts = contracts.filter(c => c.amount >= filters.minAmount);
        if (filters.maxAmount !== undefined) contracts = contracts.filter(c => c.amount <= filters.maxAmount);
        if (filters.keyword) {
          const kw = filters.keyword.toLowerCase();
          contracts = contracts.filter(c =>
            c.name.toLowerCase().includes(kw) || c.contractNumber.toLowerCase().includes(kw)
          );
        }

        return contracts;
      }

      async updateContract(id, fields) {
        const index = this._contracts.findIndex(c => c.id === id);
        if (index !== -1) {
          Object.assign(this._contracts[index], fields, { updatedAt: new Date().toISOString() });
          return this._contracts[index];
        }
        throw new Error('Contract not found');
      }

      reset() {
        this._contracts = this._generateData(50);
      }
    }

    // ==================== HTML ç”Ÿæˆå™¨ ====================
    class HTMLGenerator {
      generateTable(data, columns, options = {}) {
        const { title = 'åˆåŒæ•°æ®æŠ¥è¡¨', subtitle = '' } = options;

        return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${this._escape(title)}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; line-height: 1.5; color: #333; background: #f5f5f5; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 24px 32px; }
    .header h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
    .header .subtitle { font-size: 14px; opacity: 0.9; }
    .summary { display: flex; gap: 24px; padding: 20px 32px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .summary-item { flex: 1; }
    .summary-label { font-size: 12px; color: #6c757d; margin-bottom: 4px; }
    .summary-value { font-size: 20px; font-weight: 600; color: #333; }
    .table-container { padding: 24px 32px; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #f8f9fa; }
    th { padding: 12px 16px; text-align: left; font-weight: 600; color: #495057; border-bottom: 2px solid #dee2e6; }
    td { padding: 12px 16px; border-bottom: 1px solid #e9ecef; }
    tbody tr:nth-child(even) { background: #f8f9fa; }
    tbody tr:hover { background: #f1f3f5; }
    .status-active { background: #d4edda; color: #155724; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
    .status-expired { background: #f8d7da; color: #721c24; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
    .status-draft { background: #fff3cd; color: #856404; padding: 4px 12px; border-radius: 12px; font-size: 12px; }
    .footer { padding: 16px 32px; background: #f8f9fa; border-top: 1px solid #e9ecef; font-size: 12px; color: #6c757d; text-align: center; }
    @media print { body { background: #fff; padding: 0; } .container { box-shadow: none; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>${this._escape(title)}</h1>
      ${subtitle ? `<p class="subtitle">${this._escape(subtitle)}</p>` : ''}
    </div>
    ${this._generateSummary(data)}
    <div class="table-container">
      <table>
        <thead>
          <tr>
            ${columns.map(c => `<th>${this._escape(c.label || c.field)}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${data.map(row => `
          <tr>
            ${columns.map(c => `<td>${this._formatCell(row, c)}</td>`).join('')}
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
    <div class="footer">
      ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}
    </div>
  </div>
</body>
</html>`;
      }

      _generateSummary(data) {
        if (!data.length) return '';
        const totalAmount = data.reduce((sum, r) => sum + (r.amount || 0), 0);
        const statusCount = data.reduce((acc, r) => { acc[r.status] = (acc[r.status] || 0) + 1; return acc; }, {});
        return `
    <div class="summary">
      <div class="summary-item"><div class="summary-label">æ€»è®°å½•æ•°</div><div class="summary-value">${data.length}</div></div>
      <div class="summary-item"><div class="summary-label">æ€»é‡‘é¢</div><div class="summary-value">Â¥${totalAmount.toLocaleString()}</div></div>
      <div class="summary-item"><div class="summary-label">ç”Ÿæ•ˆä¸­</div><div class="summary-value">${statusCount.active || 0}</div></div>
      <div class="summary-item"><div class="summary-label">å·²è¿‡æœŸ</div><div class="summary-value">${statusCount.expired || 0}</div></div>
    </div>`;
      }

      _formatCell(row, column) {
        const value = this._getValue(row, column.field);
        if (value === null || value === undefined) return '-';
        switch (column.type) {
          case 'currency':
            const num = parseFloat(value);
            return isNaN(num) ? '-' : new Intl.NumberFormat('zh-CN', { style: 'currency', currency: column.currency || 'CNY' }).format(num);
          case 'date':
            const d = new Date(value);
            return isNaN(d.getTime()) ? value : d.toISOString().split('T')[0];
          case 'status':
            const statusMap = { 'active': 'ç”Ÿæ•ˆä¸­', 'expired': 'å·²è¿‡æœŸ', 'draft': 'è‰ç¨¿', 'terminated': 'å·²ç»ˆæ­¢' };
            return `<span class="status-${value}">${statusMap[value] || value}</span>`;
          default:
            return this._escape(String(value));
        }
      }

      _getValue(obj, path) {
        const keys = path.split('.');
        let value = obj;
        for (const key of keys) {
          if (value && typeof value === 'object') value = value[key];
          else return '';
        }
        return value !== undefined ? value : '';
      }

      _escape(str) {
        return String(str).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
      }
    }

    // ==================== åˆå§‹åŒ– ====================
    const dataSource = new MockDataSource();
    const htmlGenerator = new HTMLGenerator();
    let filteredData = [];
    let currentPage = 1;
    const pageSize = 10;

    function delay(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function log(message, type = 'info') {
      const logContent = document.getElementById('logContent');
      const time = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      logContent.innerHTML = `<div class="log-entry"><span class="log-time">[${time}]</span><span class="${className}">${message}</span></div>` + logContent.innerHTML;
    }

    // ==================== åŠ è½½æ•°æ® ====================
    async function loadData() {
      log('å¼€å§‹åŠ è½½æ•°æ®...');
      const status = document.getElementById('statusFilter').value;
      const type = document.getElementById('typeFilter').value;
      const keyword = document.getElementById('searchInput').value;

      const filters = {};
      if (status) filters.status = status;
      if (type) filters.type = type;
      if (keyword) filters.keyword = keyword;

      filteredData = await dataSource.getContracts(filters);
      currentPage = 1;

      log(`åŠ è½½å®Œæˆï¼Œå…± ${filteredData.length} æ¡æ•°æ®`, 'success');
      renderTable();
      renderStats();
      renderPagination();
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredData.slice(start, end);

      if (pageData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#8892b0;">æš‚æ— æ•°æ®</td></tr>';
        return;
      }

      tbody.innerHTML = pageData.map(row => `
        <tr>
          <td>${row.id}</td>
          <td>${row.contractNumber}</td>
          <td>${row.name}</td>
          <td>${row.type}</td>
          <td>${new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(row.amount)}</td>
          <td>${row.counterparty}</td>
          <td><span class="status-badge status-${row.status}">${{active:'ç”Ÿæ•ˆä¸­',expired:'å·²è¿‡æœŸ',draft:'è‰ç¨¿',terminated:'å·²ç»ˆæ­¢'}[row.status]||row.status}</span></td>
          <td>${row.startDate}</td>
          <td>${row.endDate}</td>
        </tr>
      `).join('');
    }

    function renderStats() {
      const totalAmount = filteredData.reduce((sum, r) => sum + (r.amount || 0), 0);
      const statusCount = filteredData.reduce((acc, r) => { acc[r.status] = (acc[r.status] || 0) + 1; return acc; }, {});

      document.getElementById('stats').innerHTML = `
        <div class="stat-card">
          <div class="stat-label">æ€»è®°å½•æ•°</div>
          <div class="stat-value">${filteredData.length}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æ€»é‡‘é¢</div>
          <div class="stat-value highlight">Â¥${totalAmount.toLocaleString()}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ç”Ÿæ•ˆä¸­</div>
          <div class="stat-value">${statusCount.active || 0}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²è¿‡æœŸ</div>
          <div class="stat-value">${statusCount.expired || 0}</div>
        </div>
      `;
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      const pagination = document.getElementById('pagination');

      let buttons = `<button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</button>`;

      for (let i = 1; i <= totalPages; i++) {
        buttons += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      buttons += `<button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;

      pagination.innerHTML = buttons;
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredData.length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderTable();
      renderPagination();
    }

    function applyFilters() {
      loadData();
    }

    // ==================== å¯¼å‡ºæŠ¥è¡¨ ====================
    function exportHTML() {
      log('å¼€å§‹ç”Ÿæˆ HTML æŠ¥è¡¨...');

      const columns = [
        { field: 'id', label: 'ID' },
        { field: 'contractNumber', label: 'åˆåŒç¼–å·' },
        { field: 'name', label: 'åˆåŒåç§°' },
        { field: 'type', label: 'ç±»å‹' },
        { field: 'amount', label: 'é‡‘é¢', type: 'currency' },
        { field: 'counterparty', label: 'å¯¹æ–¹å•ä½' },
        { field: 'status', label: 'çŠ¶æ€', type: 'status' },
        { field: 'startDate', label: 'å¼€å§‹æ—¥æœŸ', type: 'date' },
        { field: 'endDate', label: 'ç»“æŸæ—¥æœŸ', type: 'date' }
      ];

      const html = htmlGenerator.generateTable(filteredData, columns, {
        title: 'åˆåŒæ•°æ®æŠ¥è¡¨',
        subtitle: 'ç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString('zh-CN')
      });

      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `contract-report-${new Date().toISOString().split('T')[0]}.html`;
      a.click();
      URL.revokeObjectURL(url);

      log('HTML æŠ¥è¡¨å¯¼å‡ºæˆåŠŸï¼', 'success');
    }

    function exportCSV() {
      log('å¼€å§‹ç”Ÿæˆ CSV æŠ¥è¡¨...');

      const csv = generateCSV(filteredData);

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `contract-data-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);

      log('CSV æŠ¥è¡¨å¯¼å‡ºæˆåŠŸï¼', 'success');
    }

    function generateCSV(data) {
      const escapeCSV = (str) => {
        if (str === null || str === undefined) return '';
        const s = String(str);
        if (s.includes(',') || s.includes('"') || s.includes('\n')) {
          return `"${s.replace(/"/g, '""')}"`;
        }
        return s;
      };

      const statusMap = { 'active': 'ç”Ÿæ•ˆä¸­', 'expired': 'å·²è¿‡æœŸ', 'draft': 'è‰ç¨¿', 'terminated': 'å·²ç»ˆæ­¢' };

      // è¡¨å¤´
      const headers = ['ID', 'åˆåŒç¼–å·', 'åˆåŒåç§°', 'ç±»å‹', 'é‡‘é¢', 'å¯¹æ–¹å•ä½', 'çŠ¶æ€', 'å¼€å§‹æ—¥æœŸ', 'ç»“æŸæ—¥æœŸ'];
      let csv = headers.map(escapeCSV).join(',') + '\n';

      // æ•°æ®è¡Œ
      for (const row of data) {
        const values = [
          row.id,
          row.contractNumber,
          row.name,
          row.type,
          row.amount,
          row.counterparty,
          statusMap[row.status] || row.status,
          row.startDate,
          row.endDate
        ].map(escapeCSV);
        csv += values.join(',') + '\n';
      }

      return csv;
    }

    // å…¼å®¹æ—§çš„å‡½æ•°å
    const exportData = exportHTML;

    // ==================== ç”Ÿæˆè„šæœ¬ ====================
    function showGeneratedScript() {
      const script = `// åˆåŒå¤„ç†è„šæœ¬ - è‡ªåŠ¨ç”Ÿæˆ
// é…ç½®
const USER_CONFIG = {
  export: {
    title: 'åˆåŒæ•°æ®æŠ¥è¡¨',
    columns: [
      { field: 'contractNumber', label: 'åˆåŒç¼–å·' },
      { field: 'name', label: 'åˆåŒåç§°' },
      { field: 'amount', label: 'é‡‘é¢', type: 'currency' }
    ]
  }
};

// ä½¿ç”¨æ–¹æ³•
// 1. ä¿®æ”¹ USER_CONFIG é…ç½®
// 2. è¿è¡Œ: node native.template.js execute

module.exports = { USER_CONFIG };`;

      document.getElementById('scriptContent').textContent = script;
      document.getElementById('scriptPanel').style.display = 'block';
      log('å·²ç”Ÿæˆ native.js è„šæœ¬æ¨¡æ¿', 'success');
    }

    function copyScript() {
      const script = document.getElementById('scriptContent').textContent;
      navigator.clipboard.writeText(script);
      log('è„šæœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    function resetData() {
      dataSource.reset();
      log('æ•°æ®å·²é‡ç½®', 'success');
      loadData();
    }

    // ==================== Native.js æµ‹è¯•å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰====================
    // çŠ¶æ€æ˜ å°„è¡¨
    const statusMap = {
      'active': 'ç”Ÿæ•ˆä¸­',
      'expired': 'å·²è¿‡æœŸ',
      'draft': 'è‰ç¨¿',
      'terminated': 'å·²ç»ˆæ­¢'
    };

    // è·å–ä¸­æ–‡çŠ¶æ€
    function getStatusText(status) {
      return statusMap[status] || status;
    }

    // å½“å‰æ˜¾ç¤ºçš„æ•°æ®ï¼ˆç”¨äºå±•å¼€/æŠ˜å ï¼‰
    let currentTestContracts = [];
    let isExpanded = false;

    // æ¸²æŸ“æµ‹è¯•ç»“æœ
    function renderTestResult(contracts, showAll = false) {
      const resultEl = document.getElementById('testResult');
      if (!resultEl) return;

      currentTestContracts = contracts;
      isExpanded = showAll;

      const displayCount = showAll ? contracts.length : Math.min(3, contracts.length);

      let output = `âœ… æµ‹è¯•é€šè¿‡ï¼\n\n`;
      output += `ğŸ“Š æµ‹è¯•å‡½æ•°: getContracts()\n`;
      output += `ğŸ“¦ è·å–æ•°æ®: ${contracts.length} æ¡åˆåŒ\n`;
      output += `â±ï¸ å“åº”æ—¶é—´: < 100ms\n\n`;
      output += `ğŸ“‹ æ•°æ®åˆ—è¡¨ï¼ˆ${showAll ? 'å…¨éƒ¨' : 'å‰' + displayCount + 'æ¡'}ï¼‰:\n`;
      output += `${'â”€'.repeat(50)}\n`;

      for (let i = 0; i < displayCount; i++) {
        const c = contracts[i];
        output += `\n[${i + 1}] ${c.name}\n`;
        output += `    ç¼–å·: ${c.contractNumber}\n`;
        output += `    ç±»å‹: ${c.type}\n`;
        output += `    é‡‘é¢: Â¥${c.amount.toLocaleString()}\n`;
        output += `    çŠ¶æ€: ${getStatusText(c.status)}\n`;
      }

      output += `\n\n${'='.repeat(50)}\n`;
      output += `âš™ï¸ æ“ä½œæŒ‰é’®ï¼š\n`;

      if (!showAll) {
        output += `ğŸ“– æ˜¾ç¤º ${displayCount}/${contracts.length} æ¡`;
        output += `\n\n<button onclick="expandTestData()" style="background: #667eea; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; margin-top: 10px;">ğŸ“‚ å±•å¼€å…¨éƒ¨ (${contracts.length} æ¡)</button>`;
      } else {
        output += `ğŸ“– æ˜¾ç¤ºå…¨éƒ¨ ${contracts.length} æ¡`;
        output += `\n\n<button onclick="collapseTestData()" style="background: #4a5568; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; margin-top: 10px;">ğŸ“ æ”¶èµ·ï¼ˆæ˜¾ç¤ºå‰3æ¡ï¼‰</button>`;
      }

      resultEl.innerHTML = output;
    }

    function expandTestData() {
      renderTestResult(currentTestContracts, true);
    }

    function collapseTestData() {
      renderTestResult(currentTestContracts, false);
    }

    async function testFetchAll() {
      const resultEl = document.getElementById('testResult');
      if (!resultEl) return;

      resultEl.textContent = 'æ­£åœ¨æµ‹è¯•...';

      try {
        const contracts = await dataSource.getContracts({});
        renderTestResult(contracts, false);
        log(`æµ‹è¯•æˆåŠŸ: è·å– ${contracts.length} æ¡æ•°æ®`, 'success');
      } catch (error) {
        resultEl.textContent = `âŒ æµ‹è¯•å¤±è´¥\n\né”™è¯¯: ${error.message}`;
        log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testFetchFilterSimple() {
      const resultEl = document.getElementById('testResult');
      if (!resultEl) return;

      resultEl.textContent = 'æ­£åœ¨æµ‹è¯•...';

      try {
        const status = document.getElementById('testStatusFilter')?.value;
        const type = document.getElementById('testTypeFilter')?.value;
        const maxAmount = document.getElementById('testMaxAmount')?.value;

        const filters = {};
        if (status) filters.status = status;
        if (type) filters.type = type;
        if (maxAmount) filters.maxAmount = Number(maxAmount);

        const contracts = await dataSource.getContracts(filters);

        // ä½¿ç”¨ renderTestResult æ¥æ”¯æŒå±•å¼€/æŠ˜å åŠŸèƒ½
        renderTestResult(contracts, false);
        log(`ç­›é€‰æˆåŠŸ: ${contracts.length} æ¡æ•°æ®`, 'success');
      } catch (error) {
        resultEl.textContent = `âŒ æµ‹è¯•å¤±è´¥\n\né”™è¯¯: ${error.message}`;
        log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // ç®€åŒ–ç‰ˆçš„ testUpdate
    async function testUpdate() {
      const resultEl = document.getElementById('testResult');
      if (!resultEl) return;

      resultEl.textContent = 'æ­£åœ¨æµ‹è¯•æ›´æ–°åŠŸèƒ½...';

      try {
        const allContracts = await dataSource.getContracts({});
        const randomContract = allContracts[Math.floor(Math.random() * Math.min(10, allContracts.length))];

        const oldAmount = randomContract.amount;
        const newAmount = Math.floor(oldAmount * 1.1);
        const oldStatus = randomContract.status;

        const updates = { status: 'active', amount: newAmount };
        const updated = await dataSource.updateContract(randomContract.id, updates);

        let output = `âœ… æ›´æ–°æµ‹è¯•é€šè¿‡ï¼\n\n`;
        output += `ğŸ“Š æµ‹è¯•å‡½æ•°: updateContract(id, fields)\n\n`;
        output += `ğŸ“ æ›´æ–°çš„åˆåŒ: ${randomContract.id}\n`;
        output += `${'â”€'.repeat(50)}\n\n`;
        output += `æ›´æ–°å‰:\n`;
        output += `    é‡‘é¢: Â¥${oldAmount.toLocaleString()}\n`;
        output += `    çŠ¶æ€: ${getStatusText(oldStatus)}\n\n`;
        output += `æ›´æ–°å:\n`;
        output += `    é‡‘é¢: Â¥${newAmount.toLocaleString()} (å¢åŠ  10%)\n`;
        output += `    çŠ¶æ€: ${getStatusText('active')}\n\n`;
        output += `â° æ›´æ–°æ—¶é—´: ${new Date(updated.updatedAt).toLocaleString('zh-CN')}\n`;
        output += `\nâœ… æ•°æ®å·²ä¿å­˜ï¼Œä¸Šæ–¹è¡¨æ ¼ä¼šè‡ªåŠ¨åˆ·æ–°`;

        resultEl.textContent = output;
        log(`æ›´æ–°æˆåŠŸ: åˆåŒ ${randomContract.id}`, 'success');
        loadData();
      } catch (error) {
        resultEl.textContent = `âŒ æµ‹è¯•å¤±è´¥\n\né”™è¯¯: ${error.message}`;
        log(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // ==================== åˆå§‹åŒ– ====================

    // è‡ªå®šä¹‰ä¸‹æ‹‰èœå•åŠŸèƒ½
    let openDropdown = null;

    function toggleDropdown(id) {
      const menu = document.getElementById(id + 'Menu');
      const trigger = document.getElementById(id + 'Trigger');

      // å…³é—­å…¶ä»–æ‰“å¼€çš„ä¸‹æ‹‰èœå•
      if (openDropdown && openDropdown !== menu) {
        openDropdown.style.display = 'none';
      }

      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        openDropdown = menu;
      } else {
        menu.style.display = 'none';
        openDropdown = null;
      }
    }

    // åˆå§‹åŒ–ä¸‹æ‹‰èœå•é¡¹ç‚¹å‡»äº‹ä»¶
    function initDropdowns() {
      // ä¸»æ§åˆ¶é¢æ¿ - çŠ¶æ€ä¸‹æ‹‰èœå•
      const statusItems = document.querySelectorAll('#statusMenu .dropdown-item');
      statusItems.forEach(item => {
        item.addEventListener('click', function() {
          const value = this.dataset.value;
          const text = this.textContent;
          document.getElementById('statusFilter').value = value;
          document.getElementById('statusTrigger').textContent = text;
          document.getElementById('statusMenu').style.display = 'none';
          openDropdown = null;
          // è‡ªåŠ¨åº”ç”¨ç­›é€‰
          applyFilters();
        });
      });

      // ä¸»æ§åˆ¶é¢æ¿ - ç±»å‹ä¸‹æ‹‰èœå•
      const typeItems = document.querySelectorAll('#typeMenu .dropdown-item');
      typeItems.forEach(item => {
        item.addEventListener('click', function() {
          const value = this.dataset.value;
          const text = this.textContent;
          document.getElementById('typeFilter').value = value;
          document.getElementById('typeTrigger').textContent = text;
          document.getElementById('typeMenu').style.display = 'none';
          openDropdown = null;
          // è‡ªåŠ¨åº”ç”¨ç­›é€‰
          applyFilters();
        });
      });

      // æµ‹è¯•é¢æ¿ - çŠ¶æ€ä¸‹æ‹‰èœå•
      const testStatusItems = document.querySelectorAll('#testStatusMenu .dropdown-item');
      testStatusItems.forEach(item => {
        item.addEventListener('click', function() {
          const value = this.dataset.value;
          const text = this.textContent;
          document.getElementById('testStatusFilter').value = value;
          document.getElementById('testStatusTrigger').textContent = text;
          document.getElementById('testStatusMenu').style.display = 'none';
          openDropdown = null;
        });
      });

      // æµ‹è¯•é¢æ¿ - ç±»å‹ä¸‹æ‹‰èœå•
      const testTypeItems = document.querySelectorAll('#testTypeMenu .dropdown-item');
      testTypeItems.forEach(item => {
        item.addEventListener('click', function() {
          const value = this.dataset.value;
          const text = this.textContent;
          document.getElementById('testTypeFilter').value = value;
          document.getElementById('testTypeTrigger').textContent = text;
          document.getElementById('testTypeMenu').style.display = 'none';
          openDropdown = null;
        });
      });

      // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-dropdown')) {
          if (openDropdown) {
            openDropdown.style.display = 'none';
            openDropdown = null;
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initDropdowns();

      // æœç´¢å›è½¦æ”¯æŒ
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('keyup', (e) => {
          if (e.key === 'Enter') applyFilters();
        });
      }

      log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
      log('æç¤ºï¼šå¯ä»¥ä½¿ç”¨ç­›é€‰å’Œæœç´¢åŠŸèƒ½', 'info');
      loadData();
    });
  </script>
</body>
</html>
